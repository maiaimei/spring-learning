@startuml Spring Boot Servlet Web Application Startup Process

' PlantUML 序列图参考: https://plantuml.com/zh/sequence-diagram
' org.springframework.boot:spring-boot-starter-parent:3.4.4

title Spring Boot Servlet Web Application Startup Process

!theme plain

' ========================================
' 参与者定义 - Spring Boot启动涉及的核心组件
' ========================================
participant Developer
participant SpringApplication
participant SpringApplicationRunListeners
participant DefaultApplicationContextFactory
participant AnnotationConfigServletWebServerApplicationContext
participant AnnotatedBeanDefinitionReader
participant ClassPathBeanDefinitionScanner
participant AbstractApplicationContext
participant ConfigurationClassPostProcessor
participant ConfigurationClassParser

' ========================================
' 启动入口 - SpringApplication.run()静态方法
' 这是Spring Boot应用的标准启动方式
' ========================================
Developer -> SpringApplication: run(primarySource, args)
activate SpringApplication
note over SpringApplication
    静态方法调用：new SpringApplication(primarySources).run(args)
    primarySources通常是@SpringBootApplication注解的主类
end note

' ========================================
' 阶段1：SpringApplication实例构造
' 初始化SpringApplication实例的关键属性
' ========================================
group SpringApplication实例构造
    SpringApplication -> SpringApplication: 推断应用类型
    note right
        根据classpath中的类判断应用类型：
        • SERVLET: 传统Web应用
        • REACTIVE: WebFlux响应式应用  
        • NONE: 非Web应用
        
        this.webApplicationType = 
        WebApplicationType.deduceFromClasspath();
    end note
    
    SpringApplication -> SpringApplication: 设置初始化器
    note right
        从META-INF/spring.factories加载
        ApplicationContextInitializer实例
        用于自定义初始化ApplicationContext
        
        setInitializers((Collection) 
        getSpringFactoriesInstances(
        ApplicationContextInitializer.class));
    end note
    
    SpringApplication -> SpringApplication: 设置监听器
    note right
        从META-INF/spring.factories加载
        ApplicationListener实例
        用于监听应用事件
        
        setListeners((Collection) 
        getSpringFactoriesInstances(
        ApplicationListener.class));
    end note
end

' ========================================
' 阶段2：应用启动执行 - run(args)方法核心逻辑
' Spring Boot启动的关键步骤
' ========================================
group 应用启动执行 run(args)
    ' 获取运行时监听器
    SpringApplication -> SpringApplication: getRunListeners()
    note right
        从META-INF/spring.factories加载
        SpringApplicationRunListener实例
        
        SpringApplicationRunListener接口用于
        监听Spring Boot应用启动过程中的
        各个关键阶段，允许开发者在不同
        时间点插入自定义逻辑
    end note

    ' ========================================
    ' 启动监听器通知 - starting事件
    ' 标志着Spring Boot应用开始启动
    ' ========================================
    SpringApplication -> SpringApplicationRunListeners: starting()
    activate SpringApplicationRunListeners
    note right
        通知所有注册的SpringApplicationRunListener
        实例应用启动开始
        
        可用于执行预启动逻辑，此时应用环境、
        上下文等均未初始化，适合在最早期
        进行准备工作
    end note
    SpringApplicationRunListeners --> SpringApplication:
    deactivate SpringApplicationRunListeners

    ' ========================================
    ' 环境准备 - 配置Environment
    ' 创建和配置ConfigurableEnvironment实例
    ' ========================================
    SpringApplication -> SpringApplication: prepareEnvironment()
    activate SpringApplication
    note right
        Spring Boot启动过程中负责创建和
        配置应用环境的核心方法
    end note
    
        SpringApplication -> SpringApplication: getOrCreateEnvironment()
        activate SpringApplication
            SpringApplication -> DefaultApplicationContextFactory: createEnvironment()
            activate DefaultApplicationContextFactory
            note right
                根据webApplicationType创建对应的
                Environment实现：
                • StandardServletEnvironment
                • StandardReactiveEnvironment
                • StandardEnvironment
            end note
            DefaultApplicationContextFactory --> SpringApplication: ConfigurableEnvironment
            deactivate DefaultApplicationContextFactory
        deactivate SpringApplication
        
        SpringApplication -> SpringApplication: configureEnvironment()
        note right
            配置属性源优先级：
            1. 命令行参数
            2. 系统属性
            3. 环境变量
            4. application.properties/yml
        end note

        SpringApplication -> SpringApplication: 附加配置属性源
        note right
            ConfigurationPropertySources.attach(environment)
            将配置属性源附加到环境中，
            确保属性源处于正确位置
        end note
        
        SpringApplication -> SpringApplicationRunListeners: environmentPrepared()
        activate SpringApplicationRunListeners
        note right
            通知监听器Environment已准备好
            可用于修改环境属性
            
            当环境配置准备完成、但应用上下文
            尚未创建时触发，可用于对环境
            进行自定义修改
        end note
        SpringApplicationRunListeners --> SpringApplication:
        deactivate SpringApplicationRunListeners
    deactivate SpringApplication

    ' 打印Banner
    SpringApplication -> SpringApplication: printBanner(environment)
    note right
        打印Spring Boot启动横幅
        可通过spring.banner.location自定义
    end note

    ' ========================================
    ' 创建应用上下文 - ApplicationContext
    ' 根据应用类型创建对应的上下文实现
    ' ========================================
    SpringApplication -> SpringApplication: createApplicationContext()
    activate SpringApplication
    
        SpringApplication -> DefaultApplicationContextFactory: create(webApplicationType)
        activate DefaultApplicationContextFactory
        note right
            根据webApplicationType创建对应的
            ApplicationContext实现：
            • SERVLET: AnnotationConfigServletWebServerApplicationContext
            • REACTIVE: AnnotationConfigReactiveWebServerApplicationContext
            • NONE: AnnotationConfigApplicationContext
        end note
        
        DefaultApplicationContextFactory -> AnnotationConfigServletWebServerApplicationContext: new()
        activate AnnotationConfigServletWebServerApplicationContext
        note right
            创建AnnotationConfigServletWebServerApplicationContext
            实例，适用于SERVLET类型的Web应用
        end note

            ' 注册注解Bean定义读取器
            AnnotationConfigServletWebServerApplicationContext -> AnnotatedBeanDefinitionReader: new AnnotatedBeanDefinitionReader(this)
            activate AnnotatedBeanDefinitionReader
            note right
                调用AnnotationConfigUtils: registerAnnotationConfigProcessors()方法
                注册后处理器：
                • ConfigurationClassPostProcessor: 处理@Configuration类
                • AutowiredAnnotationBeanPostProcessor: 处理@Autowired注解
                • CommonAnnotationBeanPostProcessor: 处理@Resource等注解
                
                注册工具Bean：
                • EventListenerMethodProcessor: 处理@EventListener注解
                • DefaultEventListenerFactory: 事件监听器工厂
            end note
            AnnotatedBeanDefinitionReader --> AnnotationConfigServletWebServerApplicationContext:
            deactivate AnnotatedBeanDefinitionReader

            ' 注册类路径扫描器
            AnnotationConfigServletWebServerApplicationContext -> ClassPathBeanDefinitionScanner: new ClassPathBeanDefinitionScanner(this)
            activate ClassPathBeanDefinitionScanner
            ClassPathBeanDefinitionScanner --> AnnotationConfigServletWebServerApplicationContext:
            deactivate ClassPathBeanDefinitionScanner
            
        AnnotationConfigServletWebServerApplicationContext --> DefaultApplicationContextFactory: ConfigurableApplicationContext
        deactivate AnnotationConfigServletWebServerApplicationContext
        
        DefaultApplicationContextFactory --> SpringApplication: ConfigurableApplicationContext
        deactivate DefaultApplicationContextFactory
    deactivate SpringApplication

    ' ========================================
    ' 上下文准备 - prepareContext
    ' 配置ApplicationContext的基本属性
    ' ========================================
    SpringApplication -> SpringApplication: prepareContext()
    activate SpringApplication
    
        SpringApplication -> AnnotationConfigServletWebServerApplicationContext: setEnvironment(environment)
        activate AnnotationConfigServletWebServerApplicationContext
        note right
            将Environment设置到ApplicationContext
        end note
        AnnotationConfigServletWebServerApplicationContext --> SpringApplication:
        deactivate AnnotationConfigServletWebServerApplicationContext

        SpringApplication -> SpringApplication: postProcessApplicationContext()
        note right
            对ApplicationContext进行后处理
            如注册特定的Bean定义
        end note

        SpringApplication -> SpringApplication: applyInitializers(context)
        note right
            执行所有ApplicationContextInitializer
            对ApplicationContext进行自定义初始化
        end note

        SpringApplication -> SpringApplicationRunListeners: contextPrepared()
        activate SpringApplicationRunListeners
        note right
            通知监听器ApplicationContext已准备好
            但尚未加载Bean定义
        end note
        SpringApplicationRunListeners --> SpringApplication:
        deactivate SpringApplicationRunListeners

        SpringApplication -> SpringApplication: load(context, sources)
        note right
            加载主配置类到ApplicationContext
            通常是@SpringBootApplication注解的主类
        end note

        SpringApplication -> SpringApplicationRunListeners: contextLoaded()
        activate SpringApplicationRunListeners
        note right
            通知监听器ApplicationContext已加载完成
            Bean定义已注册，但尚未刷新
        end note
        SpringApplicationRunListeners --> SpringApplication:
        deactivate SpringApplicationRunListeners
    deactivate SpringApplication

    ' ========================================
    ' 刷新应用上下文 - refreshContext
    ' Spring容器的核心初始化过程
    ' ========================================
    SpringApplication -> SpringApplication: refreshContext(context)
    activate SpringApplication
    
        SpringApplication -> AbstractApplicationContext: refresh()
        activate AbstractApplicationContext
        note right
            Spring容器刷新的核心方法
            执行Bean的实例化、依赖注入等操作
        end note
        
            ' 准备刷新
            AbstractApplicationContext -> AbstractApplicationContext: prepareRefresh()
            note right
                准备刷新上下文：
                • 设置启动时间
                • 初始化属性源
                • 验证必需属性
            end note
            
            ' 获取Bean工厂
            AbstractApplicationContext -> AbstractApplicationContext: obtainFreshBeanFactory()
            note right
                获取ConfigurableListableBeanFactory
                对于AnnotationConfigServletWebServerApplicationContext
                返回DefaultListableBeanFactory实例
            end note
            
            ' 准备Bean工厂
            AbstractApplicationContext -> AbstractApplicationContext: prepareBeanFactory(beanFactory)
            note right
                配置BeanFactory的标准上下文特性：
                • 设置类加载器
                • 添加Bean后处理器
                • 注册默认环境Bean
            end note
            
            ' 后处理Bean工厂
            AbstractApplicationContext -> AbstractApplicationContext: postProcessBeanFactory(beanFactory)
            note right
                允许子类对BeanFactory进行后处理
                AnnotationConfigServletWebServerApplicationContext
                会注册Web相关的作用域和Bean
            end note
            
            ' 调用Bean工厂后处理器
            AbstractApplicationContext -> AbstractApplicationContext: invokeBeanFactoryPostProcessors(beanFactory)
            activate AbstractApplicationContext
            note right
            Instantiate and invoke all registered BeanDefinitionRegistryPostProcessors beans, respecting explicit order if given.
            • Invoke BeanDefinitionRegistryPostProcessors first, if any.
            • First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.
            • Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.
            • Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.
            • Now, invoke the postProcessBeanFactory callback of all processors handled so far.
            Instantiate and invoke all registered BeanFactoryPostProcessor beans, respecting explicit order if given.
            • First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.
            • Next, invoke the BeanFactoryPostProcessors that implement Ordered.
            • Finally, invoke all other BeanFactoryPostProcessors.
            end note
            deactivate AbstractApplicationContext
            
            ' 注册Bean后处理器
            AbstractApplicationContext -> AbstractApplicationContext: registerBeanPostProcessors(beanFactory)
            note right
                注册BeanPostProcessor实例：
                • AutowiredAnnotationBeanPostProcessor
                • CommonAnnotationBeanPostProcessor
                • 等其他后处理器
            end note
            
            ' 初始化消息源
            AbstractApplicationContext -> AbstractApplicationContext: initMessageSource()
            note right
                初始化MessageSource用于国际化
            end note
            
            ' 初始化事件多播器
            AbstractApplicationContext -> AbstractApplicationContext: initApplicationEventMulticaster()
            note right
                初始化ApplicationEventMulticaster
                用于发布应用事件
            end note
            
            ' 刷新特定上下文
            AbstractApplicationContext -> AbstractApplicationContext: onRefresh()
            note right
                ServletWebServerApplicationContext重写此方法
                创建并启动嵌入式Web服务器（如Tomcat）
            end note
            
            ' 注册监听器
            AbstractApplicationContext -> AbstractApplicationContext: registerListeners()
            note right
                注册ApplicationListener实例
                包括静态指定的和Bean定义的监听器
            end note
            
            ' 完成Bean工厂初始化
            AbstractApplicationContext -> AbstractApplicationContext: finishBeanFactoryInitialization(beanFactory)
            note right
                实例化所有剩余的单例Bean：
                • 预实例化单例Bean
                • 执行依赖注入
                • 调用初始化方法
            end note
            
            ' 完成刷新
            AbstractApplicationContext -> AbstractApplicationContext: finishRefresh()
            note right
                完成刷新过程：
                • 初始化LifecycleProcessor
                • 发布ContextRefreshedEvent事件
                • 启动Lifecycle Bean
            end note
        AbstractApplicationContext --> SpringApplication:
        deactivate AbstractApplicationContext
    deactivate SpringApplication

    ' ========================================
    ' 启动后处理 - afterRefresh
    ' 应用启动完成后的清理工作
    ' ========================================
    SpringApplication -> SpringApplication: afterRefresh(context, applicationArguments)
    note right
        刷新后的回调方法
        默认实现为空，可由子类重写
    end note

    ' ========================================
    ' 启动完成通知 - started事件
    ' 通知所有监听器应用已启动完成
    ' ========================================
    SpringApplication -> SpringApplicationRunListeners: started()
    activate SpringApplicationRunListeners
    note right
        通知监听器应用已启动完成
        此时ApplicationContext已完全初始化
        所有Bean已创建并可用
    end note
    SpringApplicationRunListeners --> SpringApplication:
    deactivate SpringApplicationRunListeners

    ' ========================================
    ' 调用运行器 - callRunners
    ' 执行ApplicationRunner和CommandLineRunner
    ' ========================================
    SpringApplication -> SpringApplication: callRunners(context, applicationArguments)
    note right
        按顺序执行所有ApplicationRunner和CommandLineRunner：
        1. 先执行ApplicationRunner实例
        2. 再执行CommandLineRunner实例
        
        这些Runner用于在应用启动完成后
        执行特定的初始化逻辑
    end note

    ' ========================================
    ' 就绪通知 - ready事件
    ' 应用完全启动并准备接收请求
    ' ========================================
    SpringApplication -> SpringApplicationRunListeners: ready()
    activate SpringApplicationRunListeners
    SpringApplicationRunListeners --> SpringApplication:
    deactivate SpringApplicationRunListeners
end

' ========================================
' 返回结果 - 启动成功
' 返回可配置的ApplicationContext实例
' ========================================
SpringApplication --> Developer: 返回ConfigurableApplicationContext
note left of Developer
应用启动成功
可通过返回的ApplicationContext
获取Bean和管理应用生命周期
end note

@enduml
